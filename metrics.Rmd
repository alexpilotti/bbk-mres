---
title: "Metrics"
output:
  html_document: default
  pdf_document: default
params:
  chain: "HL"
  data_path: !r file.path(getwd(), "data")
---
```{r warning = FALSE, message = FALSE, cache = FALSE}
if(!require("jsonlite")) {
  install.packages("jsonlite")
}
library(jsonlite)

if(!require("ggplot2")) {
  install.packages("ggplot2")
}
library(ggplot2)

if(!require("stringr")) {
  install.packages("stringr")
}
library(stringr)

library(glue)
```

```{r cache = FALSE}
data_path <- params$data_path
chain <- params$chain

PT <- "PT"
FT <- "FT"

load_json_files <- function(training) {
  metrics <- data.frame()

  json_files <- list.files(
    path = data_path,
    pattern = glue("^predict_metrics_.*_{chain}_{training}\\.json$"),
    full.names = TRUE
  )

  for (json_file in json_files) {
    json_data <- fromJSON(json_file)
    model_name <- str_match(
      basename(json_file),
      glue("^predict_metrics_(.*?)_{chain}_{training}\\.json$")
    )[, 2]

    json_data <- data.frame(
      precision = json_data$precision,
      recall = json_data$recall,
      specificity = json_data$specificity,
      f1 = json_data$f1,
      apr = json_data$apr,
      balanced_accuracy = json_data$balanced_accuracy,
      auc = json_data$auc,
      mcc = json_data$mcc,
      test_loss = json_data$test_loss,
      model = model_name,
      training = training
    )

    metrics <- rbind(metrics, json_data)
  }

  return(metrics)
}

metrics_pt <- load_json_files(PT)
metrics_ft <- load_json_files(FT)
metrics <- rbind(metrics_pt, metrics_ft)

plot_data <- function(metrics, metric_name) {
  data_range <- max(metrics[metric_name]) - min(metrics[metric_name])
  binwidth_value <- data_range / 30
  y_label = tools::toTitleCase(metric_name)

  p <- ggplot(metrics, aes(x = model, y = .data[[metric_name]], fill = training)) +
    geom_dotplot(
      binaxis = 'y',
      stackdir = 'center',
      binwidth = binwidth_value,
      show.legend = TRUE
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(
        hjust = 0.5,
        face = "bold",
        size = 16
      ),
      axis.title.x = element_text(margin = margin(t = 10)),
      axis.title.y = element_text(margin = margin(r = 10))
    ) +
    scale_fill_manual(
      labels = c(FT = "Fine-tuned", PT = "Pre-trained"),
      values = c(FT = "#00BFC4", PT = "#F8766D")
    ) +
    labs(
      title = y_label,
      x = "Model",
      y = y_label,
      fill = "Training"
    ) +
    scale_x_discrete(guide = guide_axis(n.dodge = 2))
  p
}
```

```{r cache = FALSE}
plot_data(metrics, "precision")
```

```{r cache = FALSE}
plot_data(metrics, "specificity")
```

```{r cache = FALSE}
plot_data(metrics, "recall")
```

```{r cache = FALSE}
plot_data(metrics, "f1")
```

```{r cache = FALSE}
plot_data(metrics, "apr")
```

```{r cache = FALSE}
plot_data(metrics, "balanced_accuracy")
```

```{r cache = FALSE}
plot_data(metrics, "auc")
```

```{r cache = FALSE}
plot_data(metrics, "mcc")
```
