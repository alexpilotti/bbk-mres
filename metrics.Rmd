---
title: "Metrics"
output:
  html_document: default
  pdf_document: default
params:
  chain: "HL"
  data_path: !r file.path(getwd(), "data")
---
```{r warning = FALSE, message = FALSE, cache = FALSE}
if(!require("jsonlite")) {
  install.packages("jsonlite")
}
library(jsonlite)

if(!require("ggplot2")) {
  install.packages("ggplot2")
}
library(ggplot2)

library(glue)

library(stringr)
```

```{r cache = FALSE}
data_path <- params$data_path
chain <- params$chain

metrics <- data.frame()

json_files <- list.files(
  path = data_path,
  pattern = glue("^predict_metrics_.*_{chain}\\.json$"),
  full.names = TRUE
)

for (json_file in json_files) {
  json_data <- fromJSON(json_file)
  model_name <- str_match(basename(json_file),
                          glue("^predict_metrics_(.*?)_{chain}\\.json$"))[, 2]

  json_data <- data.frame(
    precision = json_data$precision,
    recall = json_data$recall,
    f1 = json_data$f1,
    apr = json_data$apr,
    balanced_accuracy = json_data$balanced_accuracy,
    auc = json_data$auc,
    mcc = json_data$mcc,
    test_loss = json_data$test_loss,
    model = model_name
  )

  metrics <- rbind(metrics, json_data)
}

plot_data <- function(metrics, metric_name) {
  data_range <- max(metrics[metric_name]) - min(metrics[metric_name])
  binwidth_value <- data_range / 30

  p <- ggplot(metrics, aes(x = model, y = .data[[metric_name]], fill = model)) +
    geom_dotplot(
      binaxis = 'y',
      stackdir = 'center',
      binwidth = binwidth_value,
      show.legend = FALSE
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(
        hjust = 0.5,
        face = "bold",
        size = 16
      ),
      axis.title.x = element_text(margin = margin(t = 10)),
      axis.title.y = element_text(margin = margin(r = 10))
    ) +
    labs(title = metric_name, x = "Model", y = metric_name) +
    scale_x_discrete(guide = guide_axis(n.dodge = 2))
  p
}
```

```{r cache = FALSE}
plot_data(metrics, "precision")
```

```{r cache = FALSE}
plot_data(metrics, "recall")
```

```{r cache = FALSE}
plot_data(metrics, "f1")
```

```{r cache = FALSE}
plot_data(metrics, "apr")
```

```{r cache = FALSE}
plot_data(metrics, "balanced_accuracy")
```

```{r cache = FALSE}
plot_data(metrics, "auc")
```

```{r cache = FALSE}
plot_data(metrics, "mcc")
```
